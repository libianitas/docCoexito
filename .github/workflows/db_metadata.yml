name: ADW Thin + Wallet (DB_* secrets)

on:
  workflow_dispatch:

jobs:
  adw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install oracledb

      # 1) Decodificar wallet desde secret (CAMBIA el nombre si tu secret se llama distinto)
      - name: Decode Wallet
        env:
          WALLET_B64: ${{ secrets.WALLET_B64 }}
        run: |
          mkdir -p wallet
          echo "$WALLET_B64" | base64 -d > wallet.zip
          unzip -o wallet.zip -d wallet
          echo "Wallet files:"
          ls -la wallet

      # 2) Asegurar que sqlnet.ora apunte al directorio correcto (CRÍTICO en runners)
      - name: Fix sqlnet.ora DIRECTORY
        run: |
          sed -i 's|DIRECTORY=".*"|DIRECTORY="./wallet"|g' wallet/sqlnet.ora || true
          sed -i 's|DIRECTORY=.*|DIRECTORY=./wallet|g' wallet/sqlnet.ora || true
          echo "=== sqlnet.ora ==="
          cat wallet/sqlnet.ora

      # 3) Test de conexión (Thin + Wallet)
      - name: Test ADW connection
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SERVICE: ${{ secrets.DB_SERVICE }}
          WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD }}
          WALLET_DIR: ${{ github.workspace }}/wallet
        run: |
          python - <<'PY'
          import os
          import oracledb

          user = os.environ["DB_USER"]
          password = os.environ["DB_PASSWORD"]
          dsn = os.environ["DB_SERVICE"]          # TNS alias (ej: adwanalyticsprod_high)
          wallet_dir = os.environ["WALLET_DIR"]   # /home/runner/work/<repo>/<repo>/wallet
          wallet_password = os.environ["WALLET_PASSWORD"]

          # Thin + Wallet: set defaults (más estable en CI)
          oracledb.defaults.config_dir = wallet_d
